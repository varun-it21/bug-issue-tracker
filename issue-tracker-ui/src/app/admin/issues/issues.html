<div class="filters">
  <input type="text" placeholder="Search title..." [(ngModel)]="searchText">

  <select [(ngModel)]="selectedStatus">
    <option value="">All Status</option>
    <option value="Open">Open</option>
    <option value="InProgress">In-Progress</option>
    <option value="Completed">Completed</option>
  </select>

  <select [(ngModel)]="selectedPriority">
    <option value="">All Priority</option>
    <option value="High">High</option>
    <option value="Medium">Medium</option>
    <option value="Low">Low</option>
  </select>
  <button (click)="goToAddIssue()">Add Issue</button>
</div>


<div class="issues-container">

  <h2>All Issues</h2>

  <table>
    <thead>
      <tr>
        <th>ID</th>
        <th>Title</th>
        <th>Description</th>
        <th>Priority</th>
        <th>Status</th>
        <th>Assignee</th>
        <th>Deadline</th>
        <th>Comments</th>
        <th>Action</th>
      </tr>
    </thead>

    <tbody>
      <tr *ngFor="let issue of paginatedIssues">
        <td>{{ issue.issueId }}</td>
        <td>{{ issue.title }}</td>
        <td>{{ issue.description }}</td>
        <td>
          <span class="badge" [ngClass]="issue.priority">{{ issue.priority }}</span>
        </td>
        <td>
          <span class="status" [ngClass]="issue.status">{{ issue.status }}</span>
        </td>
        <td>{{ userMap[issue.assignedTo] || 'Unknown' }}</td>



        <td [ngClass]="{'overdue': isOverdue(issue.deadline)}">
          {{ issue.deadline | date:'yyyy-MM-dd' }}
        </td>

        <td>
  <ng-container *ngIf="commentsMap[issue.issueId]?.length; else noComments">
    {{ commentsMap[issue.issueId][0]?.commentText }}
  </ng-container>

  <ng-template #noComments>
    <span class="no-comment">No comments</span>
  </ng-template>
</td>
        <td class="actions">
          <button (click)="openView(issue)">View</button>
          <button (click)="openEdit(issue)">Edit</button>
          <button (click)="openDelete(issue)">Delete</button>
        </td>
      </tr>
    </tbody>
  </table>
</div>

<div class="pagination">
  <button (click)="changePage(currentPage - 1)" [disabled]="currentPage === 1">
    Prev
  </button>

  <button *ngFor="let page of [].constructor(totalPages); let i = index" (click)="changePage(i + 1)"
    [class.active]="currentPage === i + 1">
    {{ i + 1 }}
  </button>

  <button (click)="changePage(currentPage + 1)" [disabled]="currentPage === totalPages">
    Next
  </button>
</div>

<div class="modal" *ngIf="showView">
  <div class="modal-content">
    <h3>View Issue üëÅÔ∏è</h3>

    <p><b>ID:</b> {{ selectedIssue.issueId }}</p>
    <p><b>Title:</b> {{ selectedIssue.title }}</p>
    <p><b>Description:</b> {{ selectedIssue.description }}</p>
    <p><b>Priority:</b> {{ selectedIssue.priority }}</p>
    <p><b>Status:</b> {{ selectedIssue.status }}</p>
    <p><b>Assignee:</b> {{ userMap[selectedIssue.assignedTo] }}</p>
    <p><b>Deadline:</b> {{ selectedIssue.deadline | date:'yyyy-MM-dd' }}</p>

    <h4>üí¨ Comments</h4>

<div *ngIf="commentsMap[selectedIssue?.issueId]?.length === 0">
  <p>No comments yet.</p>
</div>

<div *ngFor="let c of commentsMap[selectedIssue?.issueId]" class="comment-box">
  <p><b>User ID:</b> {{ c.cmtBy }}</p>
  <p>{{ c.commentText }}</p>
  <small>{{ c.cmtAt | date:'short' }}</small>
  <hr>
</div>

    <textarea [(ngModel)]="newComment" placeholder="Write a comment..."></textarea>
    <br>
    <button (click)="addComment()">Post Comment</button>

    <div class="modal-actions">
      <button class="btn delete" (click)="closePopup()">Close</button>
    </div>
  </div>
</div>

<div class="modal" *ngIf="showEdit">
  <div class="modal-content">
    <h3>Edit Issue ‚úèÔ∏è</h3>

    <label>Title</label>
    <input [(ngModel)]="selectedIssue.title">

    <label>Description</label>
    <textarea [(ngModel)]="selectedIssue.description" name="description" required>
</textarea>

    <label>Priority</label>
    <select [(ngModel)]="selectedIssue.priority">
      <option>High</option>
      <option>Medium</option>
      <option>Low</option>
    </select>

    <label>Status</label>
<select [(ngModel)]="selectedIssue.status">
  <option value="Open">Open</option>
  <option value="InProgress">In-Progress</option>
  <option value="Completed">Completed</option>
</select>

    <label>Assignee</label>
<select [(ngModel)]="selectedIssue.assignedTo">
  <option [ngValue]="null">Select User</option>
  <option *ngFor="let user of users" [ngValue]="user.userId">
    {{ user.user_name }}
  </option>
</select>

    <label>Deadline</label>
    <input type="date" [(ngModel)]="selectedIssue.deadline">

    <div class="modal-actions">
      <button class="btn edit" (click)="saveEdit()">Save ‚úÖ</button>
      <button class="btn delete" (click)="closePopup()">Cancel ‚ùå</button>
    </div>
  </div>
</div>

<div class="modal" *ngIf="showDelete">
  <div class="modal-content">
    <h3>Delete Issue üóëÔ∏è</h3>
    <p>Are you sure you want to delete this issue?</p>

    <p><b>{{ selectedIssue.title }}</b></p>

    <div class="modal-actions">
      <button class="btn edit" (click)="confirmDelete()">Yes, Delete</button>
      <button class="btn delete" (click)="closePopup()">Cancel</button>
    </div>
  </div>
</div>